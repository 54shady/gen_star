###### compile kernel ###############
#rm -rvf  op/obj/KERNEL/drivers/gpu/arm/mali400/ump/linux
#rm -rvf  op/obj/KERNEL/drivers/gpu/arm/mali400/mali/linux
mkdir -p op/obj/KERNEL/drivers/gpu/arm/mali400/ump/linux
mkdir -p op/obj/KERNEL/drivers/gpu/arm/mali400/mali/linux
mkdir -p op/obj/KERNEL/drivers/net/wireless/rockchip_wlan/wifi_sys

cp -rf kernel/logo.bmp op/obj/KERNEL/
cp -rfd kernel/drivers/gpu/arm/mali400/ump/arch-default op/obj/KERNEL/drivers/gpu/arm/mali400/ump/
cp -rfd kernel/drivers/gpu/arm/mali400/ump/linux/license op/obj/KERNEL/drivers/gpu/arm/mali400/ump/linux/license
cp -rfd kernel/drivers/gpu/arm/mali400/mali/linux/license op/obj/KERNEL/drivers/gpu/arm/mali400/mali/linux/license

#make config
#make -C kernel fireprime_defconfig  O=/home/zerowaylin/fireprimes/out/target/product/rk312x/obj/KERNEL CROSS_COMPILE=/home/zerowaylin/fireprimes/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi- ARCH=arm

#make
make -C kernel -j8 rk3128-fireprime.img  O=/home/zerowaylin/fireprimes/out/target/product/rk312x/obj/KERNEL CROSS_COMPILE=/home/zerowaylin/fireprimes/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi- ARCH=arm
###### compile kernel ###############

############ start make images #################
#set -e

. build/envsetup.sh >/dev/null && setpaths

export PATH=$ANDROID_BUILD_PATHS:$PATH
TARGET_PRODUCT=`get_build_var TARGET_PRODUCT`
TARGET_HARDWARE=`get_build_var TARGET_BOARD_HARDWARE`
echo TARGET_PRODUCT=$TARGET_PRODUCT
echo TARGET_HARDWARE=$TARGET_HARDWARE
TARGET="withoutkernel"

IMG_TARGET='all'

echo IMG_TARGET=$IMG_TARGET , ota = $TARGET

IMAGE_PATH=rockdev/Image-$TARGET_PRODUCT

FSTYPE=ext4
echo system filesysystem is $FSTYPE

BOARD_CONFIG=device/rockchip/common/device.mk

KERNEL_SRC_PATH="$PWD/out/target/product/rk312x/obj/KERNEL"
echo $KERNEL_SRC_PATH

[ $(id -u) -eq 0 ] || FAKEROOT=fakeroot

BOOT_OTA="ota"

cp -rfv $KERNEL_SRC_PATH/arch/arm/boot/zImage /home/zerowaylin/fireprimes/out/target/product/rk312x/kernel

echo -n "create boot.img without kernel... "
[ -d $OUT/root ] && \
mkbootfs $OUT/root | minigzip > $OUT/ramdisk.img && \
truncate -s "%4" $OUT/ramdisk.img && \
rkst/mkkrnlimg $OUT/ramdisk.img $IMAGE_PATH/boot.img >/dev/null
echo "done."

echo -n "create system.img... "
system_size=`ls -l $OUT/system.img | awk '{print $5;}'`
[ $system_size -gt "0" ] || { echo "Please make first!!!" && exit 1; }
MAKE_EXT4FS_ARGS=" -L system -S $OUT/root/file_contexts -a system $IMAGE_PATH/system.img $OUT/system"
ok=0
while [ "$ok" = "0" ]; do
	make_ext4fs -l $system_size $MAKE_EXT4FS_ARGS >/dev/null 2>&1 &&
	tune2fs -c -1 -i 0 $IMAGE_PATH/system.img >/dev/null 2>&1 &&
	ok=1 || system_size=$(($system_size + 5242880))
done
e2fsck -fyD $IMAGE_PATH/system.img >/dev/null 2>&1 || true
echo "done."

echo "Copy kenrel.img..."
echo "Copy resource.img..."
cp $KERNEL_SRC_PATH/kernel.img $IMAGE_PATH/
cp $KERNEL_SRC_PATH/resource.img $IMAGE_PATH/

chmod a+r -R $IMAGE_PATH/
############ end make images #################

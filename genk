###### compile kernel ###############
#rm -rvf kobj/drivers/gpu/arm/mali400/ump/linux
#rm -rvf kobj/drivers/gpu/arm/mali400/mali/linux
mkdir -p kobj/drivers/gpu/arm/mali400/ump/linux
mkdir -p kobj/drivers/gpu/arm/mali400/mali/linux
mkdir -p kobj/drivers/net/wireless/rockchip_wlan/wifi_sys
mkdir -p kobj/drivers/gpu/arm/mali400/mali/include/linux/mali

cp -rf kernel/logo.bmp op/obj/KERNEL/
cp -rfd kernel/drivers/gpu/arm/mali400/ump/arch-default op/obj/KERNEL/drivers/gpu/arm/mali400/ump/
cp -rfd kernel/drivers/gpu/arm/mali400/ump/linux/license op/obj/KERNEL/drivers/gpu/arm/mali400/ump/linux/license
cp -rfd kernel/drivers/gpu/arm/mali400/mali/linux/license op/obj/KERNEL/drivers/gpu/arm/mali400/mali/linux/license
cp kernel/drivers/gpu/arm/mali400/mali/include/linux/mali/mali_utgard_uk_types.h kobj/drivers/gpu/arm/mali400/mali/include/linux/mali/
cp kernel/logo.bmp kobj/

#make menuconfig
#make -C kernel O=/home/zerowaytp/src/fireprimes/out/target/product/rk312x/obj/KERNEL CROSS_COMPILE=/home/zerowaytp/src/fireprimes/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi- ARCH=arm menuconfig

#make config
#make -C kernel fireprime_defconfig  O=/home/zerowaytp/src/fireprimes/out/target/product/rk312x/obj/KERNEL CROSS_COMPILE=/home/zerowaytp/src/fireprimes/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi- ARCH=arm

#make
make -C kernel -j9 rk3128-fireprime.img  O=/home/zerowaytp/src/fireprimes/out/target/product/rk312x/obj/KERNEL CROSS_COMPILE=/home/zerowaytp/src/fireprimes/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi- ARCH=arm

#make modules
make -C kernel -j9 O=/home/zerowaytp/src/fireprimes/out/target/product/rk312x/obj/KERNEL CROSS_COMPILE=/home/zerowaytp/src/fireprimes/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi- ARCH=arm modules

#make module install
#make INSTALL_MOD_PATH=/home/zerowaytp/src/fireprimes/out/target/product/rk312x/obj/KERNEL/modules_install modules_install

###### compile kernel ###############

############ start make images #################
#set -e

. build/envsetup.sh >/dev/null && setpaths

export PATH=$ANDROID_BUILD_PATHS:$PATH
TARGET_PRODUCT=`get_build_var TARGET_PRODUCT`
TARGET_HARDWARE=`get_build_var TARGET_BOARD_HARDWARE`
echo TARGET_PRODUCT=$TARGET_PRODUCT
echo TARGET_HARDWARE=$TARGET_HARDWARE
TARGET="withoutkernel"

IMG_TARGET='all'

echo IMG_TARGET=$IMG_TARGET , ota = $TARGET

IMAGE_PATH=rockdev/Image-$TARGET_PRODUCT

FSTYPE=ext4
echo system filesysystem is $FSTYPE

BOARD_CONFIG=device/rockchip/common/device.mk

KERNEL_SRC_PATH="$PWD/out/target/product/rk312x/obj/KERNEL"
echo $KERNEL_SRC_PATH

[ $(id -u) -eq 0 ] || FAKEROOT=fakeroot

BOOT_OTA="ota"

cp -rfv $KERNEL_SRC_PATH/arch/arm/boot/zImage /home/zerowaytp/src/fireprimes/out/target/product/rk312x/kernel

echo -n "create boot.img without kernel... "
[ -d $OUT/root ] && \
mkbootfs $OUT/root | minigzip > $OUT/ramdisk.img && \
truncate -s "%4" $OUT/ramdisk.img && \
rkst/mkkrnlimg $OUT/ramdisk.img $IMAGE_PATH/boot.img >/dev/null
echo "done."

echo "Copy kenrel.img..."
echo "Copy resource.img..."
cp $KERNEL_SRC_PATH/kernel.img $IMAGE_PATH/
cp $KERNEL_SRC_PATH/resource.img $IMAGE_PATH/

chmod a+r -R $IMAGE_PATH/
############ end make images #################
